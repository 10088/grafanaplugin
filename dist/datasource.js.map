{"version":3,"sources":["../src/datasource.js"],"names":["GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","headers","Authorization","getAuthorization","jsonData","options","targets","buildQueryParameters","length","when","data","doRequest","method","then","response","status","message","title","datasourceRequest","res","_","map","target","find","refId","isObject","timeshift","datapoints","unit2millis","seconds","minutes","hours","days","weeks","months","datapoint","period","unit","value","alias","generateAlias","sql","generateSql","input","_keyStr","output","chr1","chr2","chr3","enc1","enc2","enc3","enc4","i","charCodeAt","isNaN","charAt","defaultUser","user","defaultPassword","password","encode","replace","scopedVars","queryStart","range","from","toISOString","queryEnd","to","intervalMs","query","req","tempList","Array","isArray","forEach","item","end","push","expendable","text","Set"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport \"moment\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.headers = {'Content-Type': 'application/json'};\n    this.headers.Authorization = this.getAuthorization(instanceSettings.jsonData);\n  }\n\n  query(options) {\n    var targets = this.buildQueryParameters(options);\n\n    if (targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    return this.doRequest({\n      url: this.url + '/grafana/query',\n      data: targets,\n      method: 'POST'\n    });\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/grafana/heartbeat',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"TDengine Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  doRequest(options) {\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options).then(function(res) {\n      res.data = _.map(res.data, function(data) {\n        let target = _.find(options.data, { refId: data.refId });\n        if (_.isObject(target.timeshift)) {\n          data.datapoints = _(data.datapoints).map(datapoint => {\n            const unit2millis = {\n              seconds: 1000,\n              minutes: 60 * 1000,\n              hours: 60 * 60 * 1000,\n              days: 24 * 60 * 60 * 1000,\n              weeks: 7 * 24 * 60 * 60 * 1000,\n              months: 30 * 24 * 60 * 60 * 1000,\n            };\n            datapoint[1] += target.timeshift.period * unit2millis[target.timeshift.unit];\n            return datapoint\n          }).value();\n          return data;\n        }\n        return data;\n      });\n      return res;\n    });\n  }\n\n  buildQueryParameters(options) {\n\n    var targets = _.map(options.targets, target => {\n      return {\n        refId: target.refId,\n        alias: this.generateAlias(options, target),\n        sql: this.generateSql(options, target),\n        timeshift: target.timeshift\n      };\n    });\n\n    return targets;\n  }\n\n  encode(input) {\n    var _keyStr = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n    while (i < input.length) {\n      chr1 = input.charCodeAt(i++);\n      chr2 = input.charCodeAt(i++);\n      chr3 = input.charCodeAt(i++);\n      enc1 = chr1 >> 2;\n      enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n      enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n      enc4 = chr3 & 63;\n      if (isNaN(chr2)) {\n        enc3 = enc4 = 64;\n      } else if (isNaN(chr3)) {\n        enc4 = 64;\n      }\n      output = output + _keyStr.charAt(enc1) + _keyStr.charAt(enc2) + _keyStr.charAt(enc3) + _keyStr.charAt(enc4);\n    }\n\n    return output;\n  }\n\n  getAuthorization(jsonData){\n    jsonData = jsonData || {};\n    var defaultUser = jsonData.user || \"root\";\n    var defaultPassword = jsonData.password || \"taosdata\";\n\n    return \"Basic \" + this.encode(defaultUser + \":\" + defaultPassword);\n  }\n\n  generateTimeshift(options, target){\n    var alias = target.alias || \"\";\n    alias = this.templateSrv.replace(alias, options.scopedVars, 'csv');\n    return alias;\n  }\n  generateAlias(options, target){\n    var alias = target.alias || \"\";\n    alias = this.templateSrv.replace(alias, options.scopedVars, 'csv');\n    return alias;\n  }\n\n  generateSql(options, target) {\n    var sql = target.sql;\n    if (sql == null || sql == \"\"){\n      return sql;\n    }\n\n    var queryStart = \"now-1h\";\n    if (options != null && options.range != null && options.range.from != null){\n      queryStart = options.range.from.toISOString();\n    }\n\n    var queryEnd = \"now\";\n    if (options != null && options.range != null && options.range.to != null){\n      queryEnd = options.range.to.toISOString();\n    }\n    var intervalMs = options.intervalMs || \"20000\";\n\n    intervalMs += \"a\";\n    sql = sql.replace(/^\\s+|\\s+$/gm, '');\n    sql = sql.replace(\"$from\", \"'\" + queryStart + \"'\");\n    sql = sql.replace(\"$begin\", \"'\" + queryStart + \"'\");\n    sql = sql.replace(\"$to\", \"'\" + queryEnd + \"'\");\n    sql = sql.replace(\"$end\", \"'\" + queryEnd + \"'\");\n    sql = sql.replace(\"$interval\", intervalMs);\n\n    sql = this.templateSrv.replace(sql, options.scopedVars, 'csv');\n    return sql;\n  }\n  metricFindQuery(query, options) {\n  \t// query like 'select  name  from dbtest.t;'\n    const targets = [\n      {\n        alias: \"\",\n        refId: \"A\",\n        sql: query,\n      },\n    ];\n    let req = {\n      url: this.url + \"/grafana/query\",\n      data: targets,\n      method: \"POST\",\n    };\n    return this.doRequest(req).then((res) => {\n      let tempList = [];\n      (Array.isArray(res.data) ? res.data : []).forEach((item) => {\n        (Array.isArray(item.datapoints) ? item.datapoints : []).forEach(\n          (end) => {\n            tempList.push({\n              expendable: false,\n              text: end[0],\n              value: end[0],\n            });\n          }\n        );\n      });\n      return Array.from(new Set(tempList));\n    });\n  }\n\n}\n"]}